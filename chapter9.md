---

## 开放运营数据平台架构

### 背景介绍

作为一个直播平台，研发团队收到开发需求中运营类需求占了很大的比重。举例来说，运营人员经常会搞各类活动，活动的形式诸如某个节日会有某些专属礼物，那么就竞赛某段时间内，哪位主播收到的专属礼物最多，然后哪位用户送出的专属礼物最多，然后活动最后会产生一个榜单，上榜的人会得到某些虚拟的特权或奖品等。

### 解决方案

以往开发人员会针对种种类似上述的运营类需求分别立项设计开发，疲于应付，很快上线，上线运行短暂时间又很快的下线、废弃。我们对很多运营类活动需求分析整理后发现其实这些需求存在着很多的共性：

- 都涉及收发虚拟礼物或虚拟道具或用户动作事件
- 都限定特定的时间段或时间周期
- 最终都需要对特定指标排序

经过抽象分析，首先提出指标这个概念，指标主要是反应平台上某些事件的变化（如收到多少礼物，新增了多少关注等），而很多运营活动的最终目的就是得到某个指标在特定时间内的变化程度的排序，复杂点的运营活动可能会是某几个指标的组合的结果。

有了上面的结论，我们的方案就很显然了，首先要对业务模块中涉及的重要指标事件进行埋点，实时发送至消息中间件MQ；然后我们可以根据事件消息得到某个指标计算过程的指标值（如礼物数量），指标计算方法（如累加），分组键（groupby如收到礼物主播ID），条件过滤值（如礼物ID等于特定的礼物）；最后订阅指标事件，按照上面的模型实时进行计算，就可以得到某个运营指标的所有成员的实时统计了，再加上实时的排序就可以得到我们的运营活动榜单了。

我们总结了两类运营活动，一类是一次性的活动（即临时性的某个特定时间段内的活动，做完这次很长时间内都不会再用了，但为了达到竞赛的效果需要足够实时展示当前榜单情况）；另一类是周期性的运营活动（如会产生日榜、周榜、月榜等，但实时性没那么高，只要在某个特点时间点产生榜单数据即可）。

针对一次性的运营活动我们系统的处理流程比较简单：为向MQ订阅包含指标消息的topic，实时计算并累加计算指标值存于hbase中（这里时间只是作为指标计算的过滤条件，每个参与者即groupby字段只有一条值），更新每个参与者指标值的同时利用redis的sortedset维护topN的榜单。

针对周期性的运营活动系统的处理过程如下：为向MQ订阅包含指标消息的topic，实时计算并累加当前小时计算指标值存于hbase中（每个参与者每个整点小时都会有指标值汇总值，最多会保存25（一天24个小时+预留一个小时用于汇总计算天的值）条），每个小时的计算过程中同样会实时产生小时级的实时榜单，天级指标汇总计算和榜单产生是通过定时任务来产生，定时时间到了可以针对天级的所有参与者，然后从hbase中枚举出其过去24个小时各个小时的指标值，然后累加产生天级的指标值，计算过程中同样也可以通过redis产生日榜，周榜和月榜以此类推。

架构图如下：

![](/assets/运营开放数据平台服务架构.png)
