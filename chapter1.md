---
## 微服务基础框架之路

### 微服务框架选型的背景

我们是在2014年中开始考虑这个事情，当时中国开源社区普遍使用rpc框架较多尤其是阿里开源的dubbo，springcloud当时受限于文档及推广等原因还没有那么被人所熟知，但dubbo开源项目那时也已经处于了一个不再维护的状态。

### 微服务框架选型我们关注的问题

- 考虑到公司正处于一个快速发展期，而且公司业务属于高频业务，所以性能是首先要考虑的问题。
- 作为微服务的核心框架，以及考虑到后续肯定会有定制维护的需求，所以必须自主可控。
- 考虑到我们当时团队规模不是很大，普遍技术能力也不是很强，所以最好是个轻量级的框架，但又应该有很好的可扩展性，以便后续团队大了之后的扩展开发。
- 考虑到当时大部分开发人员都是从单体应用开发转型过来，最好能贴近他们原先熟悉的开发编码模式，学习曲线小，便于框架的推广。

### 自研rpc框架kkrpc

我们选择自研rpc框架，但也不等于要全部重新造轮子，我们选择站在巨人的肩膀上（dubbo基础上）定制我们自己的rpc框架。我们主要做了以下几个方面的工作：

- 轻量化，dubbo在很多层面上都支持多种实现方案，如注册中心支持zk、redis等，网络层框架支持netty、grizzly等，而对我们来说只需要选定一种掌握即可，其他实现全部砍掉。
- dubbo中很多高级功能和配置对我们需求和应用场景来说都是不需要和复杂的，因此我们也都拿掉这些不必要的功能，只保留我们需要的核心功能并保证其稳定性。
- dubbo的网络层为了扩展性抽象封装了很多层，增加了维护的复杂度，我们也把这部分简化了，牺牲了一些对我们来说不必要的扩展性，但提高了简洁性和可维护性。
- 为了更好的性能，经过调研测试，我们序列化层改为使用protostuff、同时跨语言时支持hessian，同时为了较小传输包的overhead，我们重新设计了请求包结构。
- dubbo当时在服务治理方面其实是比较弱的，我们后来在参考了Netflix的hystrix的实现后，对其服务治理功能进行了增强，支持了服务降级、限制并发访问度、线程隔离、熔断等服务治疗手段，并研发了相应的管理后台供开发运维人员使用。
- 考虑到rpc框架在可测试性方面与http比的明显不足，我们研发了kkrpc专门的测试工具平台，用户只要上传其定义的api sdk jar包就可以选择特定服务实例填写方法参数进行测试，大大方便了研发测试人员。

### kkrpc 整体设计

![](/assets/RPC整体设计.png)

### kkrpc 调用流程分析

![](/assets/RPC总体调用图.png)


